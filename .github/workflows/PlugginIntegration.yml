name: Unzip and Integrate Plugin

on:
  push:
    branches:
      - '**'

jobs:
  unzip_and_integrate:
    runs-on: ubuntu-latest

    env:
      KEYSTORE: ${{ secrets.KEYSTORE_PRODUCTION }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'adopt'
          java-version: '17'
      
      # - name: Setup Flutter
      #   uses: subosito/flutter-action@v2
      #   with:
      #       channel: 'stable'
      #       architecture: x64    

      # - name: Unzip Attendance Plugin
      #   if: contains(github.event.head_commit.message, 'Activate Attendance')
      #   run: |
      #     unzip assets/attendance.zip -d temp_unzipped_plugin -x "__MACOSX/*" "*/.DS_Store"

      # - name: Unzip Sales Plugin
      #   if: contains(github.event.head_commit.message, 'Activate Sales')
      #   run: |
      #     unzip assets/sales.zip -d temp_unzipped_plugin -x "__MACOSX/*" "*/.DS_Store"

      # - name: Move Unzipped Files
      #   if: contains(github.event.head_commit.message, 'Activate Attendance') || contains(github.event.head_commit.message, 'Activate Sales')
      #   run: |
      #     mv temp_unzipped_plugin/* lib/

      # - name: Update main.dart with Attendance Import
      #   if: contains(github.event.head_commit.message, 'Activate Attendance')
      #   run: |
      #     echo "import 'package:fieldapp_functionality/attendance/attendance.dart';" | cat - lib/main.dart > temp && mv temp lib/main.dart

      # - name: Update main.dart with Sales Import
      #   if: contains(github.event.head_commit.message, 'Activate Sales')
      #   run: |
      #     echo "import 'package:fieldapp_functionality/sales/sales.dart';" | cat - lib/main.dart > temp && mv temp lib/main.dart

      # - name: Replace Attendace in main.dart
      #   if: contains(github.event.head_commit.message, 'Activate Attendance')
      #   run: |
      #     sed -i '63,$d' lib/main.dart
      #     echo "
      #     Map<String, Widget> plugins = {'Attendance': Attendance(),}; 
      #     " >> lib/main.dart

      - name: Replace Text in invoice_scanning.dart
        if: contains(github.event.head_commit.message, 'Activate Invoice')
        run: |
          sed -i "s/title: const Text('Invoice Going')/title: const Text('Invoice Scanning')/" lib/invoice_scanning/invoice_scanning.dart

      # - name: Add Plugin Based on Commit Message
      #   if: contains(github.event.head_commit.message, 'Add plugin')
      #   run: |
      #     plugin_name=$(echo "${{ github.event.head_commit.message }}" | sed -n 's/^.*Add plugin \([^ ]*\).*$/\1/p')
      #     if [ -n "$plugin_name" ]; then
      #       flutter pub add "$plugin_name"
      #     else
      #       echo "No plugin specified in commit message."
      #     fi

      - name: Commit and Push Changes
        run: |
          git config --local user.email "palash.rambhia.sg@gretail.com"
          git config --local user.name "Palash-Onehub"
          git add .
          git commit -m "Integrated New Pluggin"

      - name: Push Changes to Branch
        run: |
          git push origin main
